<div class="tw-flex-container">
  <div class="tw-flex-container">
    <div class="m-justify-between">
      <div class="m-items-middle">
        <m-button (click)="group.open = !group.open; filter.open = false; selectedConcept = undefined" [mDisplay]="group.open ? 'primary' : 'default'">
          <m-icon mCode="folder-open"></m-icon>
        </m-button>

        <m-input [(ngModel)]="searchInput.input"
            (mChange)="search$.next()"
            placeholder="marina.ui.inputs.search.placeholder"
            [disabled]="group.open"
        ></m-input>

        <m-radio-group [(ngModel)]="searchInput.type" (ngModelChange)="search$.next()" [disabled]="group.open">
          <label m-radio-button [mValue]="'contains'">{{'web.code-system.form.concepts.contains' | translate}}</label>
          <label m-radio-button [mValue]="'eq'">{{'web.code-system.form.concepts.eq' | translate}}</label>
        </m-radio-group>

        <m-button (click)="filter.open = !filter.open"
            [mDisplay]="filter.languages || filter.propertyName || filter.propertyValue || filter.version ? 'primary' : 'default'"
            [disabled]="group.open"
        >
          <m-icon mCode="filter"></m-icon>
        </m-button>
      </div>

      <tw-add-button *ngIf="!viewMode && null | apply: getConceptEditRoute as route" [routerLink]="route.path" [queryParams]="route.query">
        {{'web.code-system.form.concepts.add-concept' | translate}}
      </tw-add-button>
    </div>

    <!-- Table filter -->
    <div *ngIf="filter.open">
      <m-form-row>
        <div *m-form-col>
          <m-form-item mLabel="web.code-system-concept.filter.version-filter">
            <m-select [(ngModel)]="filter.version"
                (ngModelChange)="initFilterLanguages(filter.version?.supportedLanguages)"
                (mChange)="search$.next()"
                [placeholder]="'web.code-system-concept.filter.select-version-placeholder' | translate"
            >
              <m-option *ngFor="let version of codeSystemVersions" [mLabel]="version.version" [mValue]="version"></m-option>
            </m-select>
          </m-form-item>
        </div>

        <div *m-form-col>
          <m-form-item mLabel="web.code-system-concept.filter.language-filter">
            <m-select [autoUnselect]="false"
                [disabled]="!filter.version?.supportedLanguages.length"
                [(ngModel)]="filter['languages']"
                multiple
                [placeholder]="'web.code-system-concept.filter.select-language-placeholder' | translate"
            >
              <m-option *ngFor="let language of filter.version?.supportedLanguages"
                  [mLabel]="language | localizedConceptName:{valueSet: 'languages'} | async"
                  [mValue]="language"
              ></m-option>
            </m-select>
          </m-form-item>
        </div>

        <div *m-form-col>
          <m-form-item mLabel="web.code-system-concept.filter.property-filter">
            <m-select [(ngModel)]="filter.propertyName"
                (ngModelChange)="filter.propertyValue = undefined"
                [placeholder]="'web.code-system-concept.filter.select-property-placeholder' | translate"
                (mChange)="search$.next()"
            >
              <m-option *ngFor="let property of properties" [mLabel]="property.name" [mValue]="property.name"></m-option>
            </m-select>
          </m-form-item>
        </div>

        <div *m-form-col>
          <m-form-item mLabel="web.code-system-concept.filter.property-name-filter">
            <m-input [disabled]="!filter.propertyName"
                [(ngModel)]="filter.propertyValue"
                [placeholder]="'web.code-system-concept.filter.search-property-value-placeholder' | translate"
                (mChange)="search$.next()"
            ></m-input>
          </m-form-item>
        </div>
      </m-form-row>
    </div>
    <!-- //Table filter -->

    <!-- Tree filter -->
    <div *ngIf="group.open">
      <m-form-row>
        <div *m-form-col>
          <m-form-item mLabel="web.code-system-concept.group.type">
            <m-select [(ngModel)]="group.type" (ngModelChange)="group.association = null; group.property = null" name="type">
              <m-option [mLabel]="'Association'" [mValue]="'association'"></m-option>
              <m-option [mLabel]="'Property'" [mValue]="'property'"></m-option>
            </m-select>
          </m-form-item>
        </div>

        <div *m-form-col>
          <m-form-item *ngIf="group.type === 'association'" mLabel="web.code-system-concept.group.association">
            <tw-association-type-search [(ngModel)]="group.association"
                (ngModelChange)="groupConcepts($event)"
                name="association"
                valuePrimitive
            ></tw-association-type-search>
          </m-form-item>
          <m-form-item *ngIf="group.type === 'property'" mLabel="web.code-system-concept.group.property">
            <m-select [(ngModel)]="group.property" (ngModelChange)="groupConcepts($event)" name="property">
              <m-option *ngFor="let property of properties" [mLabel]="property.name" [mValue]="property.id"></m-option>
            </m-select>
          </m-form-item>
        </div>
      </m-form-row>
    </div>
    <!-- //Tree filter -->
  </div>


  <div class="m-justify-between m-items-top">
    <!-- Table views -->
    <div style="flex: 4; max-width: 100%;">
      <m-backend-table
          *ngIf="!group.open"
          [mResult]="searchResult"
          [(mQuery)]="query"
          (mQueryChange)="loadData()"
          [mLoading]="loader.isLoading"
          mSize="small"
      >
        <tr *mTableHead>
          <th>{{'entities.code-system-concept.code' | translate}}</th>
          <th>{{'entities.code-system-entity-version.designations' | translate}}</th>
          <th>{{'entities.code-system-entity-version.property-values' | translate}}</th>
          <th>{{'entities.code-system-concept.description' | translate}}</th>
          <th class="tw-table-min-width">{{'web.code-system-concept.list.external' | translate}}</th>
          <th class="tw-table-min-width"></th>
        </tr>

        <tr *mTableRow="let concept"
            class="m-clickable"
            [style.background]="selectedConcept?.code === concept.code ? 'var(--color-table-background--expanded)' : 'initial'"
            (click)="selectConcept(concept)"
        >
          <ng-container *ngTemplateOutlet="rowContent; context: {node: {code: concept.code, concept}, level: 0}"></ng-container>
        </tr>

        <tr *mTableNoData>
          <td colspan="100%">
            <m-no-data></m-no-data>
          </td>
        </tr>
      </m-backend-table>


      <m-table *ngIf="group.open && rootConcepts" [mData]="rootConcepts" mSize="small">
        <tr *mTableHead>
          <th>{{'entities.code-system-concept.code' | translate}}</th>
          <th>{{'entities.code-system-entity-version.designations' | translate}}</th>
          <th>{{'entities.code-system-entity-version.property-values' | translate}}</th>
          <th>{{'entities.code-system-concept.description' | translate}}</th>
          <th class="tw-table-min-width">{{'web.code-system-concept.list.external' | translate}}</th>
          <th class="tw-table-min-width"></th>
        </tr>

        <ng-container *ngFor="let root of rootConcepts">
          <ng-container *ngTemplateOutlet="treeView; context: {node: root, level: 0}"></ng-container>
        </ng-container>

        <tr *mTableNoData>
          <td colspan="100%">
            <m-no-data></m-no-data>
          </td>
        </tr>
      </m-table>
    </div>
    <!-- //Table views -->


    <tw-code-system-concepts-list-concept-preview
        *ngIf="selectedConcept?.version"
        [codeSystemId]="codeSystemId"
        [version]="selectedConcept.version"
        [editRoute]="(selectedConcept.code | apply: getConceptEditRoute)?.path"
        style="flex: 2"
    ></tw-code-system-concepts-list-concept-preview>
  </div>


  <ng-template #treeView let-node="node" let-level="level">
    <tr
        class="m-clickable"
        [style.background]="selectedConcept?.code === node.code ? 'var(--color-table-background--expanded)' : 'initial'"
        (click)="selectConcept(node.concept)"
    >
      <ng-container *ngTemplateOutlet="rowContent; context: {node: node, level: level}"></ng-container>
    </tr>

    <ng-container *ngFor="let child of node.children">
      <ng-container *ngTemplateOutlet="treeView; context: {node: child, level: level + 1}"></ng-container>
    </ng-container>
  </ng-template>


  <ng-template #rowContent let-node="node" let-level="level">
    <td>
      <div class="m-items-middle m-bold">
        <m-icon-button
            *ngIf="group.open"
            [style.padding-left.rem]="level"
            [style.opacity]="node.expandable ? '1' : '0'"
            [mIcon]="node.loading ? 'loading' : node.expandable ? node.expanded ? 'folder-open' : 'folder' : 'file'"
            (mClick)="$event.preventDefault(); $event.stopImmediatePropagation(); loadChildConcepts(node)"
        ></m-icon-button>

        <a *ngIf="node.code | apply: getConceptEditRoute as route" [routerLink]="route.path" [queryParams]="route.query">
          {{node.code}}
        </a>
      </div>
    </td>
    <td>
      <div style="display: grid; grid-template-columns: auto 1fr; column-gap: var(--gap-default)">
        <ng-container *ngFor="let designation of (node.concept.versions | apply: findLastEntityVersion)?.designations | sort: 'language'">
          <span class="m-bold">{{designation.language}}</span>
          {{designation.name}}
        </ng-container>
      </div>
    </td>
    <td>
      <div style="display: grid; grid-template-columns: auto 1fr; column-gap: var(--gap-default)">
        <ng-container *ngFor="let property of (node.concept.versions | apply:findLastEntityVersion)?.propertyValues">
          <div class="m-bold">{{property.entityProperty}}</div>
          <tw-property-value-input
              style="text-align: right"
              viewMode
              [ngModel]="property.value"
              [propertyId]="property.entityPropertyId"
              [codeSystem]="codeSystemId"
          ></tw-property-value-input>
        </ng-container>
      </div>
    </td>
    <td>
      <m-abbreviate [mValue]="node.concept.description" mLength="150"/>
    </td>
    <td>
      <m-icon mCode="check" *ngIf="node.concept.codeSystem !== codeSystemId"></m-icon>
    </td>
    <td>
      <m-dropdown>
        <ng-container *ngIf="null | apply: getConceptEditRoute: node.code as route">
          <a *m-dropdown-item [routerLink]="route?.path" [queryParams]="route?.query">
            {{'web.code-system-concept.list.add-concept-child' | translate}}
          </a>
        </ng-container>
      </m-dropdown>
    </td>
  </ng-template>
</div>

