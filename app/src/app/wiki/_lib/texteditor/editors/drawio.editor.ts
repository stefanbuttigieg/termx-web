// https://gitlab.com/gitlab-org/gitlab/-/blob/master/app/assets/javascripts/drawio/drawio_editor.js
import {isNil} from '@kodality-web/core-util';

export const SAMPLE_DATA = 'PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB2ZXJzaW9uPSIxLjEiIHdpZHRoPSI2MDNweCIgaGVpZ2h0PSIxOTRweCIgdmlld0JveD0iLTAuNSAtMC41IDYwMyAxOTQiIGNvbnRlbnQ9IiZsdDtteGZpbGUgaG9zdD0mcXVvdDtlbWJlZC5kaWFncmFtcy5uZXQmcXVvdDsgbW9kaWZpZWQ9JnF1b3Q7MjAyMy0wNy0xNFQwNzowNTozNy43MjZaJnF1b3Q7IGFnZW50PSZxdW90O01vemlsbGEvNS4wIChYMTE7IExpbnV4IHg4Nl82NCkgQXBwbGVXZWJLaXQvNTM3LjM2IChLSFRNTCwgbGlrZSBHZWNrbykgQ2hyb21lLzExMi4wLjAuMCBTYWZhcmkvNTM3LjM2JnF1b3Q7IGV0YWc9JnF1b3Q7WnV3VDMwRDNwUjVRSm9uSEZiMTUmcXVvdDsgdmVyc2lvbj0mcXVvdDsyMS42LjImcXVvdDsgdHlwZT0mcXVvdDtlbWJlZCZxdW90OyZndDsmbHQ7ZGlhZ3JhbSBpZD0mcXVvdDstZ3ByYnYzbGJrY1oxMEZQSEpMMCZxdW90OyBuYW1lPSZxdW90O1BhZ2UtMSZxdW90OyZndDt4VmxYbDZ1Nmt2NDErL1V1Z3NIMm84akJaTEFOYjJRd09abnc2MGQwdTN0M1QrOXo1NTUxMXN5dzJyYXFWQ3BKWHdXVjZGODRYUzE4NzdlWjBrUngrUXREb3VVWHp2ekNNUFIwUk9EUHpsbGZISXg0Y2RJK2oxNjgzd3dyMytJWDgwTnN5cU40K0NZNE5rMDU1dTEzWnRqVWRSeU8zM2grM3pmemQ3R2tLYi9QMnZwcC9JTmhoWDc1azN2TG96Rjc1NTZ3NDIrK0VPZHA5akV6U3A3ZmV5ci9RL2kxa3lIem8yYit3c0xaWHpqZE44MzQzcW9XT2k1MzlENXdlUi9IL1VYdjU4TDZ1Qjcva3dINGE4bkR1SDVzTG83Z1hsOWswNDlaa3phMVg3Sy91VlRmVEhVVTd4b1FTUDJXdVRSTkM1a29aRDdpY1Z4Zmh2T25zWUdzYkt6S1YyKzg1T045SC80djRrVzVMMlY3bTFtK0V1c0hVWS85K21YUVRyb2YrbmJpOTdBMzZ2ZTRDT3dtaDJUZDFQRTdoOHZMOHRYL0U3RVhpRU16OWVFTGs1ZjVScjlQNHcrcEYzSTdYRi9HdldEbTQ2YUs0VEtnUUIrWC9wZy92N3VPLy9MQTlGUHV0NUZnNDJXbnZ6RHlhK2FuWDA0dnJiYzQrR0hIWWV5YklxYWJzdW5mR0hqMDlzQXRmenJkanQyNzJJY2JvOS9NdTFOK01EVGxOTWFnRDEvMmZPTitVdGhPbFhsYXczWUlNWXo3ZndmcU0rN0hlUG0zZUgzMG9vZjNJYThrOFpFMDV0OEJSeUl2WHZZbDJFamtueU44K0lud0QzaFRDRlA3bisvek14bjV3WWNHNU4vdUh6OTgzeitHL0FRQVBmd3ZBWEQrdVg4YSt3V2dadVN2R3VKdWVwZ0VQdGdrOURoMER6Q2dpLytmdnZuVFJKL1cvWjk5OGY4QzZ3UDZFK3dmZUdWK3V6Zno2dTFrb3Q1K3dkQytIMjQ3eXY0SGtlVExqZysxN3k2SFI5YkZEK0pTYjRaOHpKczlSb05tSEp2cWl3QjRCZSs0SjIvcU5RTVQrYVAvQ3dmdkpNWTkyamo5aGUxN09UL2cxd0VBd3lvOHlVd0JCUXdBS2ZnTDRFbzViS1lZQUJRYXBHOGZCc3dLdTM4b0krVW93NEMvalVETnJzaUFCbllPTWowUEtwT0pCbU1jVENZZExpemxHcXlwT0p6cFhCbHd1dk9VNi9DVUNHbjdRN3NCdFFFSGFpcWd4c0poakVHRkRlZWZmWGJ0Y3dwTUdqQWlVRklHV0NJQUdaeG9ZYUVMY1NjRENHOTdGR2t3USs2M0p4VGhPaGdLdUJSNFFsa1dVTVk3S2orZU40UlNvRUFkVUR0ZzJKMFpPT2tmUklXS1FVZzVrN3UzVHl0cGg0OGV0MW1tWjNENWhWRndKb1VnYjRRZ3JCK2RjQUpwZGk1bkRzeEF2MWZlOC93NG5UNDZaZWgzVk50T0NXQW1JY0VZOTJaL0xKTmkrS1JoSS9zQm1ETmVuRFpQK1JpVTZBMjZ3WEVNeGp1MGxsSVM0ajc4cHZkK1N3QmpVUTdvL1JTdGZsRFB3dkVwbVkrSlJ6TGVxZDUzbGg5S3JqdnhpTnFkVm1yWVFIY1A3RlBWb1RwMEFUN0FHQjkvM3F2MW1vWnZLeFc3OGlibktlRE5CVFBWeGdYYWFFeHdYNU9zdWd5ZVpJQzI0T1k1d1BlVnQ1NzdCN0V2bjNPNlE0T21lMGVlOHVZeld0a0dUbjVhZWd4elkxZjFyZDF0bTkxQWxLaE1KdWNVZGZnbkUzM2dzY2Z2YmtzNmhSQ3h1eDlEQ3l0ZkxPOUMycUVwaUR5SEFJcWxIRnRoSEl5anZGUko0RWdmZ0hUM0Fvb3lkbFA1MWVvcmdxd2k1dU5HaWtzZnNTNDY1WXFQbTd5cUNuNUFqTE1sWnY3RGNRMzcyQlRGY1BHQVVISWFJMXRCekxzd0RBNFhTYWR4VjNMc0NVRkl4NEZLd1NHVVJwWTU0RmNaeDREQjkrV1FMMjVqOW5aNnZVWnlYSzcyc2RmN0F3T2dLM2thbTkwYXVESWg1RWx1MW0va3dVQTBvdmJBbGVmbm5nOTVvdDB4R25XcTJtN0psTG9YazIyT0tjNXFwSm5CMHM0WldyeHBPcWNmVndwNTJFRmFFVVVxbVJ0eGVrcmE2ZUttd29FVEtISVBKSnFIMzhYdTdIREo5M3h2SkZsMThOUGJzaEg1azUrZ2VBMjV4RmxnSnBGMjJLTnBhaTFuUDgyN1U5K0Q0dFJLTjV5WmZCQTc5dXc5dVlwcGVKVzFNTzBRSVlCQjRvbFZGYzJWRGM2S2hxdFpqM2ZWNmF6ZFpPSjBqczJJUE9WSFZGaVp2b09zSStxYzVhbGNEYUVIbHdORHlTVFhhbXhWdFpRUWI1RkFTdmpqV1NnQ0U2bFltbEIwQXlHaVpwcVJRcXU0WFFqYTh1UGxVOHF6bEdDN3dPakZRUzBkYmtlTlhES3NhcTJocmo5bGNqSDJpOEUxREtZSmRqTUt1MHVpQ21GZEF0c1cvSU9ManFIaVl4T3ZTdGpLRjZWQ0RONkQxaDVmZTRJN3c0OTk5ckRWcGxxQ1pNR2hqZ1hBcEdld2YvTFZlYy9MRGFCM1B6WFlQVGFzK2o4ZFFmKzNFVzlPRHpOZHl2TFVQTHhucXRjZ21NOGg0WmhzRGpMRnZnTGp5aitRVEhIRVhDa1VWclhjdTBBcEQ1TjJLM1ZMWGMwZUF0M2tiZ3l0dk1mU1IwVHcrcnhIeEtoMk5TK3orcFExbHR3NjlvbTZ3Sk0zd2p4M1E1bHAreE9oTG93aytTSG5TVTdSVHNkSFlSY2VKMC9jNmpEMGVFdXQ4Q0cyVjdtTXJjSmxHZU1pUzJoTlBRdWZzVmFrYjVuMk9PUVJsTmhDakY4c1czeE9UdU9hNGJxaEpsek9VWU5mVFN2WmFtOGU3aU9EbXBMTVNqUXJRV2dVd0J1VHJsK1l3S0p1em5nRDlOVnNTaFpYaGJ5SUF2VGhkZmc0MjlGeHcxTU5zeDJWVWJNMkc2NU95eHRGZ1FCdkU3Y0U5RTExSGs2U1Fib1FpMjdOMld3eGF2cEFoalJMZXFvQlVleXcxQTNKUjZ1Wm1xMnFXODA5MG9WWkUrdnN4R3JaTVJsN3hlL01DYWhTVVhFdTU4MzROQkZvdDBvaGFzZkVDZ00vam16RVJhSnpPUWtadHBLbmc5ODUwclkrbS9DQm04dTI1ejRUODdqbmpYTTR1eUExNXFoRTd1cU1majc2RCtzcTBMWkxzNkJ6R2hoaytpVXBiZ1VmMXVaWjlMVTl0RHAwSzN3QzRuV29oK0xJTHBjc1NrTFZzeDZlcVowTzQ2bTl4alBTTnd2NndBZ3V5a291V2ZGYVZWR2hRRVAwUGd5N3o4Mk1ISnZJTlZoVlpMc09SWWVyTUJVZUwzZ2FyL2Fnc21QWm5nZjBLcWtsaTlnNXNaYnF4blJUSVZ6MW9LaDIrMXhGVzdPTmd6NVNxQzFaWEN0enJVcFpvYWltRjhNcUxkdWlGV1FrRmorVlZsOUF6Zlo0S3U3YWdJK253WkR2VlhFV1ZUM3hnbHlNNWxGWHE2SDBRNlFuK2NPNUNVTllobkZOVkZtYXZhbGJ3dFdaeWNpSmVYWjM3SldNUTRYYmRxSlZxcWhrVjczT2QyMzBFSm1Zd2xKMEhKa244RllWTEtra2tQUFpXRTlrdkMvV2l5TTljWlFtS0M5N0FKdDZXOXV1S0xiVXhwczFUWm0yZXN3T2xvbElzUE5hc25lbUtqVnFhUTVjaTFqK3d6VWpiM1JuRDZtTjJLOTFJaUVjVEx6alhmTDBRaTgyQkw3TXU1WWVLTFk3R25BaGtjNWR5R2NIVS9jelRPdExYU1ZzTkZSTnhZZE16NlM5NUdqZU55VitsQjdhWjhRTGxHR0tnK2IwN2oxZXoyajJGZ3BudHpXdmF0OGU3c09HWnBLTXlEUWljNktqVUlKaTE2Zm5xUXZZeXhIVjhYRXlRcWM2NE8xTmtUbmZsRlltTHhEWkp1UXN2YW5pMEZSZEtHaG1yektYYm5wb2o0bklWdWJCbjdHc2x1VlZYamlWYXJjSUdXNytHWWVYeU8wK0haMTNvaWg5YjJ5Y0FrbVBFekdHTTFhRnJtUHlSRlZLUFNjSkMvdUhNZDhWNE15UVppMk13c3pLdStOVFArc244RjdKU2N0ZXlRRll4cmw3dnZ5ZEZnMEFLMDgyRmE5Y0J2R2xtZ0RtTTFXWVhVMTRyOXZFTjJuN2xPMDFmWDRqUFlrTFN5ODR0Qko4NkZQZzVKMlMybDNJeFZZUStMS1hPSk0xb2RsNEFYS0U0ZFBSWUhPekNPbXdpN3ErNFR1azVEMElOMEtVWi9KNGRvM0tqZmZEUjBGZFRYRXhRd2JoWG5BblpKRmRiMnlnYnVGK1BtdllSYmpUVE9sUkhMTnBxRXUxMHlPYlJmVmhPd1hGQ0FwKzNjL2VTM0NiS2g2REIxTnlRZTc1NEJMaERHL1VGK2ZJZFJOV1J6WU4wejExaTVBeWhYVTk1K1FJMFpmTjdTQ2ZCdEJqQWV4Ym52VG1UVUZLZWFIbFZ6U3dhTzVwSEtlRWtwVDA3SnlJeGppNTI0QmNyelBmdW9KcXV5bFQ0WTlhSDA5MXU4RkNRTE02LzVsSHBQR3dvL3Vkc1lsV1FKaHJZTmQyNnJWRGxZZjNDTTZ5amVxZWQyTUJLUlBURDlhREtjaFdKK3RWMU0zN1FHRWZXS09NR2R6cmU0cndydGJFSWVMRzRZNVA3akxPWUJmTlpGQmJnSzRsdHVjM2xBaUY0QWFjby9vTThVeFNhbWtHdzlSS0prVjVZTWR6aU9wTHBnckRyU1A4aEVUbkhWUjRmRk9ocTZQaUdGdUVyKzRYbnZWMDl1YmdsTFJKK1BFUi9IbGJrRDBQQVg1cFJadk5IcFhkOVVFOXRyYk5KTkxOZXBaa1lON0ZjSExsTlZIM1UyNXI1eWNNZmtwU3IyYkdieUd1SlZ0WkVlaWNFcGhoT3lmN2FRRS9hTWprOGk2OUNITHRkNzdVbE41U0pTUDBvZHVVeEN4Vk1OM3pvVnBNelVkVm51dnJYczRPWkJpMUVyek9kZVU1TEtPZVNXN2dlaHhoajRlbFhyRXB5ekU2TmFuWCtMQUNvMmpMc202VEgzdVNmYUF1a1lMa2s2K01nMVBBSjQzVnp1Qm90MGVUdzF1Vy9ucFBTUUd6Qndlci8rSFJ2clpWWGFPK2tKZVBscUxyM0pmMjUzT0JLb1hmSk94U3Yrcm12Nm1XMWMvcDREZnpwOFY4UG4reldtTHB2MXN0Zlk0b1dBQkh6TERLZjc4WmZnNWhMWFl4REpBYUhKZUZMcDhwUEwzTTMrNEYrc0xzVlpCaURWWm81VXhYc25TbXRQaCtjcnova1VlOTYyTzI1UW8yMS9UTUNOTU1wTzVqWFlLVW5xSzdXclZaejRYQzgxb0dNWXB0Z1BYTXFYSENlNU5UZXlwemhMVHYwRWlDOFUwNUtkOUY0cjNWYS9La2lIQVZocXNoa004dGtwd1Zaem1mM1l2UEpPelFBZzZ1WGtqckF1R05rc2tRS1Y2ZHRERE83T3FiWFQyc1NrdzFDa0xVcmJ5eTJXR1pMK2R1Nk1hdTIyT1BMaTBxQmVVMUJHU2VWYkYwUDFKMkdTQkgzdWRvM25wZ1FtNWQ3eU1sVllDS0UxWGVEMXdLVUFjSERUZDQvYVlvVlJOUmphb0hvVE11eHJQbmZDaVFsb2E3cStZTEgxM3BEU1J5ZjVES0twVXRYS0ZHNHVtYXZHbVcxekhlY2d4ZTVJVmxuWUNNUkZ6dWtLWi9XZlpTNjVMcVZKSkZOTitLdWsrTTFpMUg4T1hpVzVuZmRUMG1FaUpKcG1DOHVvQjg2RjVLcy90bEZ6VVRLMHZvZ05mQmJGMVVIRXNEY1Q2NXhCWDJwVFM4RkFKWm16bUR2aDVJamM1d0ZGYWN0cm5GVHpvUnNqTjdzdEZUSDFlUEhrNlBCR3YweEtYenJPb2pHYUNJU2ZGUTVnZ1ZJN2RMQ0JWN05NeWtCMWdnVTRYRldvVXB4ek04NkZpQzFLd01SNnpDTjczdHByUGFza05FT1VQZGh0aUZzYTNvVUk2aU1aaXNlV1RESW9vczhTWVdlV1RYdzV6UnU0MnQ1dGxhZFU1ZkZPQ1VsVTk1UzV6S0NzM1FFcTE3U3dBYTJUNGNiTmJ4NDJxUkl6QlFCQnlFY3ZNejI5Qk4xUTl3Q1F3Zkt0b2N0MENGTnlscXVNSktoYkpZOW5FUS9hVy95MzFJblhMaGRLMFczc3BkV2hMYlBaZXY4S0xBWTc2WmU3cHJ0V0JPalZ5RDZ6S091dEtmczNFZGo5RkQ1VE5Hc2tsbW8rUW5KdktFQ1lSMWZGZHZDdk14cEFoWWFZbUFqT1M3VWtyU1ZUZVZpaVhCVVhrSXFVdXBQRUZhWStIR1NyamY4TnlIK0hCenRjNndBNGRhWFlFbU1tQllMZlhuZWp2RnRLTTNNSFVIQWxtTWhoR2pwcytXWllibk42ZWdDNU8xNFd4c0xZcEd5cnVuQW5Qeng5UFp2TVhXYno3NXZEMUVMT3JWS2hYWE9qUmI0dWtadEdFVVptSHZMM29vZUhtR0szWURveEo5NTZnblNhU0ZSQ0ZuN3B3OVR3emJzelVMQ3JLMTZYUVJJL3o1ZkU1VFRYWjRScHVtQktpOWlyRGZyMGFZc2IvbjIvLysyZnZLajk3dnI0NVI3Ri9FajNmSE9QSHpkZVlINzIrOHpvVGs3LzlXdmZWOSthY2Z6djRYJmx0Oy9kaWFncmFtJmd0OyZsdDsvbXhmaWxlJmd0OyI+PGRlZnMvPjxnPjxwYXRoIGQ9Ik0gMzAwIDEzMCBMIDMwMCA2MCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSJyZ2IoMCwgMCwgMCkiIHN0cm9rZS1taXRlcmxpbWl0PSIxMCIgcG9pbnRlci1ldmVudHM9InN0cm9rZSIvPjxyZWN0IHg9IjAiIHk9IjAiIHdpZHRoPSI2MDAiIGhlaWdodD0iNjAiIHJ4PSIxIiByeT0iMSIgZmlsbD0iIzAwMDAwMCIgc3Ryb2tlPSIjMDAwMDAwIiBwb2ludGVyLWV2ZW50cz0iYWxsIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgyLDMpIiBvcGFjaXR5PSIwLjI1Ii8+PHJlY3QgeD0iMCIgeT0iMCIgd2lkdGg9IjYwMCIgaGVpZ2h0PSI2MCIgcng9IjEiIHJ5PSIxIiBmaWxsPSJyZ2IoMjU1LCAyNTUsIDI1NSkiIHN0cm9rZT0iI2RkZGRkZCIgcG9pbnRlci1ldmVudHM9ImFsbCIvPjxnIGZpbGw9InJnYigwLCAwLCAwKSIgZm9udC1mYW1pbHk9IkhlbHZldGljYSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1zaXplPSIxMnB4Ij48dGV4dCB4PSIyOTkuNSIgeT0iMzQuNSI+V2ViPC90ZXh0PjwvZz48cmVjdCB4PSIyMzAiIHk9IjEzMCIgd2lkdGg9IjE0MCIgaGVpZ2h0PSI2MCIgcng9IjEiIHJ5PSIxIiBmaWxsPSIjMDAwMDAwIiBzdHJva2U9IiMwMDAwMDAiIHBvaW50ZXItZXZlbnRzPSJub25lIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgyLDMpIiBvcGFjaXR5PSIwLjI1Ii8+PHJlY3QgeD0iMjMwIiB5PSIxMzAiIHdpZHRoPSIxNDAiIGhlaWdodD0iNjAiIHJ4PSIxIiByeT0iMSIgZmlsbD0icmdiKDI1NSwgMjU1LCAyNTUpIiBzdHJva2U9IiNkZGRkZGQiIHBvaW50ZXItZXZlbnRzPSJub25lIi8+PGcgZmlsbD0icmdiKDAsIDAsIDApIiBmb250LWZhbWlseT0iSGVsdmV0aWNhIiBwb2ludGVyLWV2ZW50cz0ibm9uZSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1zaXplPSIxMnB4Ij48dGV4dCB4PSIyOTkuNSIgeT0iMTU3LjUiPsKgIMKgIMKgIMKgSW50ZXJuYWzCoDwvdGV4dD48dGV4dCB4PSIyOTkuNSIgeT0iMTcxLjUiPkFQSTwvdGV4dD48L2c+PGltYWdlIHg9IjI0My41IiB5PSIxNDIiIHdpZHRoPSIzNSIgaGVpZ2h0PSIzNSIgeGxpbms6aHJlZj0iZGF0YTppbWFnZS9qcGVnO2Jhc2U2NCwvOWovNEFBUVNrWkpSZ0FCQVFBQUFRQUJBQUQvMndCREFBTUNBZ01DQWdNREF3TUVBd01FQlFnRkJRUUVCUW9IQndZSURBb01EQXNLQ3dzTkRoSVFEUTRSRGdzTEVCWVFFUk1VRlJVVkRBOFhHQllVR0JJVUZSVC8yd0JEQVFNRUJBVUVCUWtGQlFrVURRc05GQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJUL3dnQVJDQURJQU1nREFTSUFBaEVCQXhFQi84UUFIUUFCQUFJQ0F3RUJBQUFBQUFBQUFBQUFBQWNJQlFrREJBWUJBdi9FQUJRQkFRQUFBQUFBQUFBQUFBQUFBQUFBQUFELzJnQU1Bd0VBQWhBREVBQUFBYlVnQUFBQUFBQUFBQUFBQUFBQUFBQUhtRDA2S2hLcUtoS3FLcEpPNEFBQUFBQUFBWW94dXZiTCtFQUJNNTZXNUhIeUFBQUFBQUFBL0p3VUw5RkF3QVBYbVp2OWo4OEFBQUFBQUFBS2wrcHB1ZkFEdUhmMkRZV1RRQUFBQUFBQUJER2ZvRWRUakFEOTNrOHpaTUFBQUFBQUFBZlBvMXorRDJHVUNPZ0JKMFlqYW9yWlpNQUFBQUFBQUFBUXhNNDFYOGR5YWJud0g3dkpSanVHMGhHVW1nQUFBQUFpNGxGcThHME5xOHlCc3pBcVhiVDhtcTFQTURBR2IyRGEzdlhteVZnYzhBQUFBSXFsV0tpZ0FHUngyUk5vWUFPdFF1L3VLTllEM2ZoQUNTTC9BR3JtWnk5cmo1QUFBQkZVcTRvMWdML2lnR1J2ZHlFb2dBQTh4cjIyWWVZTmFTLzRvQXYrSU11UkZVa25jQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQi8vRUFDZ1FBQUVEQXdNREJBTUJBQUFBQUFBQUFBWURCQVVDQnlBQUYwQUJFQlVUTURVMkZCWmdNZi9hQUFnQkFRQUJCUUwrYW15YU1IS04wUmpXNkl4cmRFWTF1aU1hM1JHTk5IYWI1dHdTSWhhalVZUVQ3b2trc0xaQUhsRk9ES1NiZUdZR0JZNExKUEMzWUpVVHUwMDZVVStBNGNKdEVENDNWSzMyQVFHcmxzaXhZb1JyVGdWVmRLZWx5VDdyUHI0REEwNktaT0VoV28vSGNHNkZ3UFc2NFEwTzVuWkFWR0d3ckdjRzVwLzR0UEJteldmdWdZTFJFbzdnM0VPNlJob29wVXNwM29vcVVydHlCMGpUYmdtNWtnSlJ6NTh2Sk84TFlnSDRGSEI2L3dDRy9rLzJQQzNYaS8yZmhtNGFnV3h6NWl2R3U4TFluLzU5SER1SUNVRTdSUk9wRlR2UlhVblhiazhwSlczRHVhQWVVVHdadkZtRG9HTkVTMk80ZDBBRDBldUVOTU9ZS1FGU2RzVlJudFhOVXFTQi9JdTllUmQ2OGk3MUh5RHJxLzcxVTlLdWx5UUhyQUw0REJLNkZwT0VtbXBCSGV6ZEg2SjNqdmtNSERkTjJnZkJDb28rd0NESmNTa1dMNUNTYWV4ZEg2SjNqdmtNWlNNYnpMQXdFM0FuSjRXN082eGgybXBTc25uZEg2SjNqdmtNaUllYWtzWVFRRG9ia3NMWkgvaTFNNVNMYlRUSGE0WTF0Y01hMnVHTkoyeUdrbE01c1pqQ09qYTRZMXRjTWEydUdOYlhER3RyaGpUTm9teGJmeDMveEFBVUVRRUFBQUFBQUFBQUFBQUFBQUFBQUFCdy85b0FDQUVEQVFFL0FTbi94QUFVRVFFQUFBQUFBQUFBQUFBQUFBQUFBQUJ3LzlvQUNBRUNBUUUvQVNuL3hBQS9FQUFCQWdFR0J3c01Bd0VBQUFBQUFBQUJBZ01FQUFVUkVpQWhNVFZBUVZHajBoTVVJaU1rTUVOU1lYSEJNalJDWW1OemdZT1RzYlBSRldEQ00vL2FBQWdCQVFBR1B3TCt0TnFuR0tFUHVob1NLcFVUOEJMR2VvZDJaWXoxRHV6TEdlb2QyWll6MUR1ekxHZW9kMlpOeERKSmFjRlpKVWtwdTdqa1RrWkZLdUZ5VURDdFdnU2NqSXBWS2xlU2tZRURRTEtKMW5CdmthRFN5MHJwRHA3c2lkaklwemMyR3hTVEl2dVVvWVJjeXoxUis3TytvcEpUTnJSNFh0RDFSSktFSkNFSkZBU01BR1F1UFBMRGJTQldVdFdBQ1ZSb2xFM05IaWtkYjFqWnEzdHdUZDd6M2dPMlRVTkROaHBoc1ZVcEdRa2swQVp6SXpmQXJvbTlzOEpRNlkvcXlpRWh4UW5DNDZjQ0U2Wk5RVUlpcTJnWWM2anBPUk9UTk56bkZqZ3hEeWZTOVVlTmxxRGhFVjNYRDhBTkprbUZZRlp3M3V1NTFxeUpjMVRlNXl4WW9lZFQwWTBkOWx1SGgyeTY4NGFxVUp6eXZvY2ozUnh6ditSMlpGdldGVUZUazZPRDdNZFl5VXRhaXRhalNWSENUWUNFQXFVbzBBRFBMZmtXa0djblI5SWFPL0lxMXprYTVjeXo0bnNrN0V4TGhkZmNOWlNqWlJPODR0OHBWZXcwcm94MWoyNUZkaGxGZnkzbk5OMUhrMWMxWHNzdy93REtlUjBWYnlOMHpWc2txM054cmQ3TDNnZXlUc05FdGxwOXMxVkpObEUwVGk1eWxOekRxdWtIVlBia20rb1ZJVE9UUTRQdEIxVEpTRnBLRnBOQlNjSU5nTFFTbFNUU0NNMHQ1eGFnSnlhSDFScDc4a1hPczN0OHNRS1htazlJTlBmWmJpSWR3dFBObXNsYWMwcjZHNDlvY2MxL29kbVNPVHpOemZGbmhSREtmUjlZZU5scU1oRjFIV3o4Q05Ca21LWU5Wd1hPdFowSzV1Y2xJVVVLRzUzcE5IU0psNTA5OVF5ODZlK29aZWRQZlVNb2JsTDMvUlBwblRZSUlwQnpHUm5DQlJUTjdoNFNSMEovVmxFWERtbE9CeG80RnAwU2FqWVJkWnRZd1owblFlYW5QNWY1VTJJWDNxZnZaY1plUUhHbGlxcENzQkVxN1FLNXVkUEZMNnZxbXpXdmNnbkxubWZFZHNtb21HY0RyRGdySlVPWm5QNWY1VTJJWDNxZnZhZGc0cHZkR0hCUVJJc09VcllYZXk5MWgrN085WXBSVk5ycDRYc3oxaEpLMEtDMEtGSVVNQkhNVG44djhxYkVMNzFQM3R1UWNVbTQzcFdNS0ZhUkp5RGlrMEtUNUtoZ1dOSXNvbXFjSE9Sck5ETHF1ak9qdTVoeURqRzkyaG5LS3lLeEZOQnB6ZDBzV2E5M2FsaXpYdTdVc1dhOTNha2xhWnRvVWswZzd1NXRjdzJtY1lVUkc1bWxKckZKSHhFc1dhOTNhbGl6WHU3VXNXYTkzYWxpelh1N1VzV2E5M2FrM0RzZ2hwc1ZVaFNpcTd2UDlQOEEvOFFBSnhBQkFBQUVCQVlEQVFFQUFBQUFBQUFBQVFBUk1VRWdJVkZoUUhHQm9iSEJNTkh3WU9ILzJnQUlBUUVBQVQ4aC9taVc2WkpGY2xaYjRwSkpKSkM4YlVpcU1nVHFjRmVTYmJhS1pmVXVTdTFodExBS2QyM3U3UUVpUmtjQ2NxZHFyb0dxMGxHWiswNWw5Njc5WVFtWWVvK00xWU9NWTJRS0FjQy9mNmtoVldFYk56Y3AvTzJMSFhDRGxaQkZEek8xWUJwdWpod0lOalRVa0JESE0zVkcvTGJXdW1HMlNzbmZMMFhpc1k1Y3cxMTRMVTdGcXUybmRUQ24rV2QwbGdnL1VpMDVybG9XNEs4c0FyMmIreHZDelp1YmdCWmNTYW1DQVNDRnZRN3VmQkpNZzlVODVvUThZenMwVlZ3R3BZSE5UWWdEbTNqblB0OG5wejRGSE9TcWF2aWQ2UWpUZFhYRFQ1cEgwRFZiVG5UZ1pwc21pY1hkK3p0Tk8rZUgwbGZSYWJ5NFJIS1NxS1BtZHF3alRkWEhEVDVwbjFEUmJYblhnMEdZT29lYzBZZWNZMlFLaVlEVXNUa291UUJ6YjF5bDIrUjE1Y0hiV0FVN052YzNoSk1uSndBc3VwSlJCQlpBQy9zZG5MaE5Ic1dxNWFmNjF3cC9ubmRCY1lQMUl0ZVM1YU4vank4OVp3YjhmcGZjZnBmY2ZwZmNIYXd6eDBtK0FHeHBJVEVoam1UcXJibnRwVFREZkpXU3ZsNmJSWEljdVlLeWZOTCt6cHd2MytKTlZSaEd6YzNPZnpsbTUxd2c1MlFUVThUdlNBYWJvNmZMTCt6cHhIS25hcWFKb2xaeG1mdEtaZld1ZmVFQmtEcXZqTlNEbkdkbWlpUHlTL3M2Y2RwSnR0b3FsOWNsZHJEZldBVjd0L1oyZ1prek14N2Q4b2dab2FpK0NTU1NXdWFlWkpUNEJMZE0waXVhTXRzVWtra2tnZU5xUUZDWXIxZjQvd0QvMmdBTUF3RUFBZ0FEQUFBQUVQUFBQUFBQUFBQUFBQUFBQUFBQUE9QUFBQUFBQUFBQUE9OUE9CUFBQUFBQUFBQUE9MUFBQUFBQUFBNUFBGUFBQUFBQUFBNUFBQUFBQUFBQUFBMRVBQSFBQUFBQUFBQUFBNUFBOUFBQUFBQUFBQUFBQR1BQUFBQUFBQUFBPTlBLTlBQUE9QUFBQUE9QUERQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUC94QUFVRVFFQUFBQUFBQUFBQUFBQUFBQUFBQUJ3LzlvQUNBRURBUUUvRUNuL3hBQVVFUUVBQUFBQUFBQUFBQUFBQUFBQUFBQncvOW9BQ0FFQ0FRRS9FQ24veEFBa0VBRUFBd0FCQkFJQ0F3RUFBQUFBQUFBQkVTRXhRUUFnUUZGaGNZR2hNR0N4d2YvYUFBZ0JBUUFCUHhEK3RNU3NTY1NpRHFsRUNoTXAzZSsrKzY3UHFyZUVwRmtFaU9QaFFjZ2hBZ1lqeXhiZ0N1ZFhObXBockZjSHZWbGJlMTJ6QUVaUnVvVWNYb2lCQUFRQVVIZ3JxMWRKZytVZ0dxZElYcFBuNjhNSS9RWU8wK0Z4SktoazlLaXdZTGFEZkVzcEFGQUFBSGduazBHUWxEaDBKZXlVZ2tROUV5YVJxbnN5TWVCb00wNW5wS3lFaDR4d0w5cXNxdHFxMitDbFNCZ0FsVmNBNmlobWVKWDdCVGxiMDdHYUZDR1NqMkhpU1ZYdEJKbUFCZWZOSzEvQkFCNFUxY3pUK0JOT0kxT0Juc0hxUUxRdnJGYS9nbFFZK0NHa2ExeUN6QWZLcjRKbG1nS1MzTUJ0NXZZUkdSUmxWdGV6aTJCUVVIeHl1QUswZEZpVTZSYUx4L3FMZ1BCZmhkQ0dwSVBhNXRTV2kwM3hMYVNoYXFxcjJJNUk2NmdBdFZZQTZqUFpnQ0V6KzFSZlNoZkNiR1BBd1NMTjMyZ2JJdzhZNVYrZ0NBQ2dBS093RlFDVjQ2T0NoMzFTa1lUUnpldkNmSGg5RThUMThyZW1qci8wYnlkdjNKOXdOUHQ2YjEwUkJHZkhoN0dQQTBXTGMzMmdaQ1E4WTRGK2tTRVNrUktld1VSR0U1Nk9TaDMwU2thUlp6V1BFT3grQkJVc25wYzJMRFRTZDRsdElRc1JFUjdFY2tkZFNJV0lraWRUbnN3aENJL1NvdnBTbmlDTE1BVWxtYUJaeGVnS01DRENKQ1BaeGJBb0tUNDRURVVhZW14S2RBc0I1LzFGd3ZoejF6TlA0RTU2REdjTU93ZXBBTnErc1ZKK1NFRWo0SWF4clhLcmNCOGlIOFZteEdTaVlDSklwK2V5QkFnRzJhUmlaUFlTcEF3Z1FpT2lkVFE3UE1yOWh0eXQ3ZGpOR2hESlQ2RHpCS3YySUc1UkFIeXRWSitTUkh3N2NCNU5Ca0lBNmRLWE1sSkpWUFJNbUU2QTdNakhnWUJORzU2U3RrWWVNY3EvWWpJallpTm5oMjRGMVNxazFmS0FERU9nYXduejhlQ1VQb2NIYWJINmt0UVFlMVJhRWxsaDNpV1VrQ2tSRVR3N2NFbklJUWdHWThrMllpanZVelp4VFBXYTZ2V2pJMmRyTm1nSXluY1JwNXZaUUNRUWtSa1R2L0I1blorWWJRbUlhVTdQZmZkT2M1a0toWXdodjhERXJFbkVBazZwVENneElkM3Z2dnV1bjZxM2hDUlJKQUJoL1QvLzJRPT0iIHByZXNlcnZlQXNwZWN0UmF0aW89Im5vbmUiIHBvaW50ZXItZXZlbnRzPSJub25lIi8+PC9nPjwvc3ZnPg==';

interface EditorFacade {
  getDiagram: () => {markdown?: string, svg: string},
  insertDiagram: (d: {diagramSvg: string}) => void,
  updateDiagram: (d: {diagramMarkdown: string, diagramSvg: string}) => void,
}

interface EditorState {
  drawioUrl: string,

  iframe: any,
  disposeEventListener: any,
  initialized: boolean,
  isBusy: boolean,

  newDiagram: boolean,
  diagramMarkdown: string,
  diagramSvg: string,
}

const _updateState = (drawIOEditorState: EditorState, data: Partial<EditorState>): void => {
  Object.assign(drawIOEditorState, data);
};

const _dispose = (drawIOEditorState: EditorState): void => {
  drawIOEditorState.disposeEventListener();
  drawIOEditorState.iframe.remove();
};

const _postMessage = (drawIOEditorState: EditorState, message): void => {
  const {origin} = new URL(drawIOEditorState.drawioUrl);
  drawIOEditorState.iframe.contentWindow.postMessage(JSON.stringify(message), origin);
};

const _getSvg = (data): string => {
  const svgPath = atob(data.substring(data.indexOf(',') + 1));
  return `<?xml version="1.0" encoding="UTF-8"?>\n\
      <!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">\n\
      ${svgPath}`;
};


/* 'init' event handler */
const prepareEditor = (drawIOEditorState: EditorState, editorFacade: EditorFacade): void => {
  const {iframe} = drawIOEditorState;

  try {
    loadExistingDiagram(drawIOEditorState, editorFacade);
    iframe.style.visibility = 'visible';
    window.scrollTo(0, 0);
    _updateState(drawIOEditorState, {
      initialized: true
    });
  } catch (e) {
    console.error(e);
    _dispose(drawIOEditorState);
  }
};

const loadExistingDiagram = (drawIOEditorState: EditorState, editorFacade: EditorFacade): void => {
  const {markdown, svg} = editorFacade.getDiagram();
  if (svg) {
    _updateState(drawIOEditorState, {
      newDiagram: false,
      diagramMarkdown: markdown,
      diagramSvg: svg,
    });
  } else {
    _updateState(drawIOEditorState, {
      newDiagram: true,
    });
  }

  _postMessage(drawIOEditorState, {
    action: 'load',
    xml: drawIOEditorState.diagramSvg,
    background: '#fff'
  });
};


/* 'export' event handler */
const saveDiagram = (drawIOEditorState: EditorState, editorFacade: EditorFacade): void => {
  const {newDiagram, diagramMarkdown, diagramSvg} = drawIOEditorState;

  try {
    if (newDiagram) {
      editorFacade.insertDiagram({diagramSvg});
    } else {
      editorFacade.updateDiagram({diagramMarkdown, diagramSvg});
    }
    setTimeout(() => _dispose(drawIOEditorState), 10);
  } catch (e) {
    _postMessage(drawIOEditorState, {
      action: 'dialog',
      titleKey: 'error',
      modified: true,
      buttonKey: 'close',
      messageKey: 'errorSavingFile',
    });
  }
};


/* main event handler */

const handleEditorMessage = (drawIOEditorState: EditorState, editorFacade: EditorFacade, evt): void => {
  if (isNil(evt) || evt.source !== drawIOEditorState.iframe.contentWindow) {
    return;
  }

  const msg = JSON.parse(evt.data);
  switch (msg.event) {
    case 'init':
      prepareEditor(drawIOEditorState, editorFacade);
      break;
    case 'save': {
      if (msg.exit) {
        _postMessage(drawIOEditorState, {
          action: 'export',
          format: 'xmlsvg'
        });
      }
      break;
    }
    case 'export':
      _updateState(drawIOEditorState, {diagramSvg: _getSvg(msg.data)});
      saveDiagram(drawIOEditorState, editorFacade);
      break;
    case 'exit':
      _dispose(drawIOEditorState);
      break;
  }
};


/* iframe */

const attachDrawioIFrameMessageListener = (drawIOEditorState: EditorState, editorFacade: EditorFacade): void => {
  const evtHandler = (evt): void => {
    handleEditorMessage(drawIOEditorState, editorFacade, evt);
  };

  window.addEventListener('message', evtHandler);

  _updateState(drawIOEditorState, {
    disposeEventListener: () => window.removeEventListener('message', evtHandler),
  });
};


const createEditorIFrame = (drawIOEditorState: EditorState): void => {
  const iframe = document.createElement('iframe');
  iframe.setAttribute('id', 'DRAWIO_FRAME_ID');
  iframe.setAttribute('src', drawIOEditorState.drawioUrl);
  iframe.setAttribute('class', 'drawio-editor');
  document.body.appendChild(iframe);

  const DRAWIO_IFRAME_TIMEOUT = 6000;
  setTimeout(() => {
    if (drawIOEditorState.initialized === false) {
      console.error('The diagrams.net editor could not be loaded.');
      _dispose(drawIOEditorState);
    }
  }, DRAWIO_IFRAME_TIMEOUT);

  _updateState(drawIOEditorState, {
    iframe,
  });
};


const createDrawioEditorState = ({drawioUrl}): EditorState => ({
  drawioUrl,
  iframe: null,
  disposeEventListener: null,
  initialized: false,
  isBusy: false,

  newDiagram: true,
  diagramMarkdown: null,
  diagramSvg: null,
});


const DRAWIO_URL = 'https://embed.diagrams.net';
const DRAWIO_PARAMS = {
  ui: 'kennedy',
  noSaveBtn: 1,
  saveAndExit: 1,
  keepmodified: 1,
  spin: 1,
  embed: 1,
  libraries: 1,
  configure: 0,
  modified: 'unsavedChanges',
  proto: 'json',
  toSvg: 1,
};

export function launchDrawioEditor({editorFacade, drawioUrl = DRAWIO_URL}: {editorFacade: EditorFacade, drawioUrl?: string}) {
  const url = new URL(drawioUrl);

  for (const [key, value] of Object.entries(DRAWIO_PARAMS)) {
    url.searchParams.set(key, value as any);
  }

  const drawIOEditorState = createDrawioEditorState({drawioUrl: url.href});

  // The execution order of these two functions matter
  attachDrawioIFrameMessageListener(drawIOEditorState, editorFacade);
  createEditorIFrame(drawIOEditorState);
}
